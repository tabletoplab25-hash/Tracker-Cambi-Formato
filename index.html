<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracker Cambi Formato - Linee Produzione</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; padding: 20px; color: #222; }
    .container { max-width: 1200px; margin: 0 auto; background: rgba(255,255,255,.96); border-radius: 20px; padding: 28px; box-shadow: 0 20px 40px rgba(0,0,0,.1); backdrop-filter: blur(8px); }
    .header { text-align: center; margin-bottom: 22px; padding-bottom: 14px; border-bottom: 3px solid #667eea; }
    .header h1 { font-size: 2.2rem; margin-bottom: 8px; }
    .date-selector { display:flex; gap:12px; align-items:center; justify-content:center; margin: 18px 0 22px; flex-wrap: wrap; }
    .date-selector input, .date-selector select { padding: 10px 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 1rem; background: #fff; }

    .tabs { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom: 18px; }
    .tab { padding: 12px 18px; background:#f7f8ff; border:1px solid #e5e7ff; border-radius: 12px; cursor:pointer; font-weight: 600; color:#444; transition:.2s; }
    .tab.active { background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; transform: translateY(-1px); box-shadow: 0 6px 18px rgba(102,126,234,.35); }

    .tab-content { display:none; animation: fadeIn .25s ease; }
    .tab-content.active { display:block; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(6px);} to {opacity:1; transform: translateY(0);} }

    .form-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; margin-bottom: 18px; }
    .form-group { background:#fff; padding: 16px; border-radius: 14px; border: 2px solid #eef0f6; box-shadow: 0 5px 15px rgba(0,0,0,.06); }
    .form-group:hover { border-color:#667eea; }
    .form-group label { display:block; font-weight:700; margin-bottom:6px; font-size:.96rem; }
    .form-group select, .form-group input { width:100%; padding: 10px 12px; border:2px solid #e1e5e9; border-radius:10px; background:#fff; }
    .form-group select:focus, .form-group input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.12); }

    .stations { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; }
    .station { background: #f8f9ff; padding: 12px; border-radius: 12px; border: 2px solid #eef0f6; }
    .station h4 { margin-bottom: 8px; font-size: .98rem; }
    .inline { display:grid; grid-template-columns: 1fr 120px; gap:8px; align-items:end; }

    .cluster { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top: 6px; }

    .save-row { text-align:center; margin: 22px 0 6px; display:flex; gap:10px; justify-content:center; flex-wrap: wrap; }
    button.primary { background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; padding: 12px 20px; border:none; border-radius: 18px; font-weight:700; cursor:pointer; box-shadow: 0 8px 24px rgba(102,126,234,.35); }
    button.soft { background: #eef0ff; color:#333; padding: 10px 14px; border: 1px solid #dfe3ff; border-radius: 12px; cursor:pointer; }
    button.danger { background: #dc3545; color:#fff; padding: 10px 14px; border: none; border-radius: 12px; cursor:pointer; }

    .status-message { display:none; text-align:center; padding: 10px; margin: 10px auto; max-width: 680px; border-radius: 10px; font-weight: 700; }
    .status-message.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .status-message.error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .status-message.warn { background:#fff3cd; color:#856404; border:1px solid #ffeeba; }

    .records { margin-top: 24px; padding-top: 18px; border-top: 2px solid #e9ecf3; }
    table { width:100%; border-collapse: collapse; background:#fff; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,.06); }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eef0f6; text-align: left; font-size: .95rem; }
    th { background:#667eea; color:#fff; position: sticky; top:0; z-index:1; }
    tr:hover td { background:#f9faff; }

    .config-wrap { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .config-card { background:#fff; padding: 14px; border-radius: 12px; border: 2px solid #eef0f6; }
    .config-card h3 { margin-bottom: 8px; }
    .config-item { display:flex; justify-content: space-between; align-items:center; padding: 8px 10px; border:1px solid #eef0f6; border-radius: 10px; margin: 6px 0; }
    .config-item button { background:transparent; border:none; cursor:pointer; font-size: 18px; }
    .pill { display:inline-flex; gap:6px; align-items:center; padding: 6px 10px; background:#eef0ff; border:1px solid #dfe3ff; border-radius: 999px; font-size:.9rem; }

    .footer-note { color:#555; font-size:.9rem; text-align:center; margin-top: 10px; }
    .mono { font-family: ui-monospace, "SF Mono", Menlo, Consolas, monospace; }

    @media (max-width: 900px){ .config-wrap{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Tracker Cambi Formato</h1>
      <p>Sistema di tracciamento per linee di produzione (3 turni)</p>
    </div>

    <div class="date-selector">
      <label for="workDate">Data:</label>
      <input type="date" id="workDate" required />
      <label for="lineaSel">Linea:</label>
      <select id="lineaSel"></select>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="mattina">üåÖ Mattina</button>
      <button class="tab" data-tab="pomeriggio">‚òÄÔ∏è Pomeriggio</button>
      <button class="tab" data-tab="notte">üåô Notte</button>
      <button class="tab" data-tab="config">‚öôÔ∏è Configurazione</button>
    </div>

    <!-- TURNI -->
    <div id="mattina" class="tab-content active"></div>
    <div id="pomeriggio" class="tab-content"></div>
    <div id="notte" class="tab-content"></div>

    <!-- CONFIGURAZIONE -->
    <div id="config" class="tab-content">
      <div class="config-wrap">
        <div class="config-card">
          <h3>Operatori</h3>
          <div class="inline" style="grid-template-columns: 1fr auto;">
            <input id="nuovo-operatore" placeholder="Aggiungi operatore" />
            <button class="soft" onclick="aggiungiOperatore()">Aggiungi</button>
          </div>
          <div id="lista-operatori"></div>
        </div>

        <div class="config-card">
          <h3>Team Leader</h3>
          <div class="inline" style="grid-template-columns: 1fr auto;">
            <input id="nuovo-team-leader" placeholder="Aggiungi team leader" />
            <button class="soft" onclick="aggiungiTeamLeader()">Aggiungi</button>
          </div>
          <div id="lista-team-leaders"></div>
        </div>

        <div class="config-card">
          <h3>Formati</h3>
          <div class="inline" style="grid-template-columns: 1fr auto;">
            <input id="nuovo-formato" placeholder="Aggiungi formato" />
            <button class="soft" onclick="aggiungiFormato()">Aggiungi</button>
          </div>
          <div id="lista-formati" style="max-height: 240px; overflow:auto"></div>
        </div>

        <div class="config-card">
          <h3>Stazioni & Casistiche</h3>
          <div id="casistiche-editor"></div>
        </div>

        <div class="config-card" style="grid-column: 1 / -1;">
          <h3>Cloud (JSONBin.io)</h3>
          <div class="cluster">
            <div>
              <label>API Key</label>
              <input id="config-api-key" placeholder="X-Master-Key" />
            </div>
            <div>
              <label>Bin ID</label>
              <input id="config-bin-id" placeholder="es. 673e5f8be41b4d34e44f8a5c" />
            </div>
            <div style="align-self:end; display:flex; gap:10px;">
              <button class="soft" onclick="salvaConfigurazioneCloud()">Salva Cloud</button>
              <button class="soft" onclick="testConnessioneCloud()">Test</button>
              <button class="soft" onclick="sincronizzaDaCloud()">‚¨áÔ∏è Scarica</button>
              <button class="soft" onclick="caricaSulCloud()">‚¨ÜÔ∏è Carica</button>
            </div>
          </div>
          <div id="cloud-status" class="status-message warn" style="display:none; margin-top:10px"></div>
        </div>

        <div class="config-card" style="grid-column: 1 / -1;">
          <h3>Backup Configurazione</h3>
          <div class="cluster">
            <div>
              <button class="soft" onclick="esportaConfigurazione()">üì§ Esporta JSON</button>
              <label class="pill" style="margin-left: 8px;">Include dati produzione</label>
            </div>
            <div>
              <input type="file" id="import-file" accept="application/json" onchange="importaConfigurazione(event)" />
            </div>
            <div style="text-align:right">
              <button class="danger" onclick="resetConfigurazione()">Ripristina Default</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="save-row">
      <button class="primary" onclick="saveData()">üíæ Salva Dati</button>
      <button class="soft" onclick="exportToCSV()">üì• Esporta CSV</button>
      <button class="soft" onclick="showStats()">üìä Statistiche</button>
      <button class="danger" onclick="clearDayData()">üóëÔ∏è Cancella Giorno</button>
    </div>

    <div id="status" class="status-message"></div>

    <div class="records">
      <h2 style="margin-bottom:8px;">üìà Storico Registrazioni</h2>
      <div style="overflow:auto; max-height: 420px;">
        <table id="recordsTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Linea</th>
              <th>Turno</th>
              <th>Operatore</th>
              <th>Team Leader</th>
              <th>Formato</th>
              <th>Cambio Prodotto</th>
              <th>Lavaggi (n¬∞)</th>
              <th>Cambio Formato</th>
              <th>Dettagli Stazioni (caso ‚Üí min)</th>
            </tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
      <p class="footer-note">I dati sono salvati in <span class="mono">localStorage</span> e, se configurato, sincronizzati su JSONBin.io.</p>
    </div>
  </div>

  <script>
    // ===== DEFAULT CONFIG estratto dal tuo Excel =====
    let appConfig = /** @type {any} */ (
      // Incolla/edita qui se vuoi personalizzare a mano
      {
        "operatori": ["Eleonora Mercuri","Francesco Pallone","Loredana Dusi"],
        "teamLeaders": ["No Team Leader","Fabio Fortini","Federico Ceccarelli","Sorin Dicianu"],
        "formati": [
          "1 Lt Carama","1,3 Lt HDPE CASSA PROMO","1,5 Lt Amuchina","1,5 Lt Calgon","1.700 Lt MTK sleeve","1,8 Lt HDPE","1,850 Lt MTK","1,25 Lt Morning fresh","1,3 Lt HDPE","1,5 Carama","2 Finto Manico","2 Lt Infus.","3 Lt Alpla (2,7)","CAMBIO FORMATO","Sleeveratura","Doypack Amm.","Doypack Cosm.","Doypack Piat.","0,080 Gel","150 ml amuchina","0,250 GENART","0,250 Lux Prof","0,250 T101","0,250 Brigel","0,250 Prof.","0,250 Intimo","0,500 Goccia","0,500 INFUS.","0,500 Tony","0,500 Bleach","0,750 INFUS.","0,780 Disgorg","0,780 INFUS.","0,000 INFUS.","1,000 INFUS.","1,000 Bleach","1,000 INFUS. Rid.","1,025 INFUS.","1,060 INFUS.","1,100 INFUS.","1,200 INFUS.","1,300 INFUS.","1,500 INFUS.","1,800 INFUS.","2,000 INFUS.","2,500 INFUS.","3,000 INFUS.","2 lt Amm.","2 lt Cosm.","2 lt Piat.","2,5 INFUS.","5 Lt Prof.","5 lt Amm.","5 lt Cosm.","5 lt Piat.","10 Lt Piat.","10 lt Prof."] ,
        "stazioni": ["Orientatore","Riempitrice","Etichettatrice","Incartonatrice","Pallettizzatore","Filmatore","Materiali"],
        "casistichePerStazione": {
          "Orientatore": ["Guasto meccanico/elett","Regolazione Etichetta","Stampante Flaconi"],
          "Riempitrice": ["Riempimento","Sorter Tappi","Centraggio/Serraggio Tappi","Incastro Flaconi/Microfermi"],
          "Etichettatrice": ["Guasto meccanico/elett","Incastro Flaconi","Stampante Lotto Cartone"],
          "Incartonatrice": ["Incastro Flaconi/Microfermi","Presa Cartoni"],
          "Pallettizzatore": ["Guasto meccanico/elett","Posizionamento errato","EPAL"],
          "Filmatore": ["Guasto meccanico/elett","Rulliera/Nastro"],
          "Materiali": ["Miscela","Flaconi","Tappi","Etichette","Cartoni","EPAL","Mancanza / NC Miscela","Mancanza / NC Flaconi","Mancanza / NC Tappi","Mancanza / NC Etichette","Mancanza / NC Cartoni","Mancanza / NC EPAL"]
        },
        "minutiCampiLabel": {"Orientatore":"O (min)","Riempitrice":"R (min)","Etichettatrice":"E (min)","Incartonatrice":"I (min)","Pallettizzatore":"P(min)","Filmatore":"F (min)","Materiali":"M (min)"},
        "linee": ["LINEA 2"],
        "cambioLineaCausali": ["Cambio Prodotto","N¬∞ Lav","Lavaggi","Cambio Formato"],
        "cloudConfig": {"apiKey":"","binId":""}
      }
    );

    // ====== VARIABILI RUNTIME ======
    let productionData = []; // archivio di tutti i record
    let API_KEY = ""; // da config
    let BIN_ID = "";  // da config

    // ====== UI BUILD ======
    const shifts = [
      { id: "mattina", label: "Turno Mattina", emoji: "üåÖ" },
      { id: "pomeriggio", label: "Turno Pomeriggio", emoji: "‚òÄÔ∏è" },
      { id: "notte", label: "Turno Notte", emoji: "üåô" }
    ];

    function buildShiftCard(shiftId){
      const root = document.getElementById(shiftId);
      root.innerHTML = "";

      const title = document.createElement('h2');
      title.textContent = shifts.find(s=>s.id===shiftId).label;
      title.style.margin = "6px 0 10px";
      root.appendChild(title);

      // intestazione
      const topGrid = document.createElement('div');
      topGrid.className = 'form-grid';
      topGrid.innerHTML = `
        <div class="form-group">
          <label for="${shiftId}-operatore">Operatore</label>
          <select id="${shiftId}-operatore"></select>
        </div>
        <div class="form-group">
          <label for="${shiftId}-team-leader">Team Leader</label>
          <select id="${shiftId}-team-leader"></select>
        </div>
        <div class="form-group">
          <label for="${shiftId}-formato">Formato Prodotto</label>
          <select id="${shiftId}-formato"></select>
        </div>
        <div class="form-group">
          <label for="${shiftId}-note">Note (opz.)</label>
          <input id="${shiftId}-note" placeholder="note libere" />
        </div>
      `;
      root.appendChild(topGrid);

      // stazioni
      const stationsWrap = document.createElement('div');
      stationsWrap.className = 'stations';

      appConfig.stazioni.forEach(station => {
        const st = document.createElement('div');
        st.className = 'station';
        st.innerHTML = `
          <h4>${station} <span style="font-weight:400; color:#667;">(${appConfig.minutiCampiLabel?.[station]||'min'})</span></h4>
          <div class="inline">
            <select id="${shiftId}-${station}-caso">
              <option value="">Seleziona casistica</option>
              ${(appConfig.casistichePerStazione[station]||[]).map(c=>`<option>${c}</option>`).join('')}
            </select>
            <input type="number" min="0" id="${shiftId}-${station}-min" placeholder="minuti" />
          </div>
        `;
        stationsWrap.appendChild(st);
      });
      root.appendChild(stationsWrap);

      // cluster cambio linea / lavaggi
      const cluster = document.createElement('div');
      cluster.className = 'cluster';
      cluster.innerHTML = `
        <div class="form-group">
          <label for="${shiftId}-cambio-prodotto">Cambio Prodotto (min)</label>
          <input id="${shiftId}-cambio-prodotto" type="number" min="0" />
        </div>
        <div class="form-group">
          <label for="${shiftId}-lavaggi">Lavaggi (n¬∞)</label>
          <input id="${shiftId}-lavaggi" type="number" min="0" />
        </div>
        <div class="form-group">
          <label for="${shiftId}-cambio-formato">Cambio Formato (min)</label>
          <input id="${shiftId}-cambio-formato" type="number" min="0" />
        </div>
      `;
      root.appendChild(cluster);
    }

    function populateSelectOptions(){
      // linea
      const lineaSel = document.getElementById('lineaSel');
      lineaSel.innerHTML = appConfig.linee.map(l=>`<option>${l}</option>`).join('');

      // operatori / TL / formati per tutti i turni
      ["mattina","pomeriggio","notte"].forEach(shift=>{
        const op = document.getElementById(`${shift}-operatore`);
        const tl = document.getElementById(`${shift}-team-leader`);
        const fm = document.getElementById(`${shift}-formato`);
        op.innerHTML = `<option value="">Seleziona operatore</option>` + appConfig.operatori.map(v=>`<option>${v}</option>`).join('');
        tl.innerHTML = `<option value="">Seleziona team leader</option>` + appConfig.teamLeaders.map(v=>`<option>${v}</option>`).join('');
        fm.innerHTML = `<option value="">Seleziona formato</option>` + appConfig.formati.map(v=>`<option>${v}</option>`).join('');
      });
    }

    function buildCasisticheEditor(){
      const root = document.getElementById('casistiche-editor');
      root.innerHTML = '';
      appConfig.stazioni.forEach(st => {
        const card = document.createElement('div');
        card.className = 'config-card';
        card.style.marginBottom = '10px';
        card.innerHTML = `<h4>${st}</h4>`;
        const list = document.createElement('div');
        (appConfig.casistichePerStazione[st]||[]).forEach((c,idx)=>{
          const row = document.createElement('div');
          row.className = 'config-item';
          row.innerHTML = `<span>${c}</span><button onclick="rimuoviCasistica('${st}', ${idx})">üóëÔ∏è</button>`;
          list.appendChild(row);
        });
        const add = document.createElement('div');
        add.className = 'inline';
        add.style.gridTemplateColumns = '1fr auto';
        add.innerHTML = `<input id="add-${st}" placeholder="Nuova casistica" /><button class='soft' onclick="aggiungiCasistica('${st}')">Aggiungi</button>`;
        card.appendChild(list);
        card.appendChild(add);
        root.appendChild(card);
      });
    }

    // ===== STATUS =====
    function showStatus(msg, type='success'){
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = `status-message ${type}`;
      el.style.display = 'block';
      clearTimeout(showStatus._t);
      showStatus._t = setTimeout(()=>{ el.style.display = 'none'; }, 5000);
    }

    // ===== CONFIG PERSISTENZA =====
    function caricaConfigurazione(){
      const saved = localStorage.getItem('appConfig');
      if(saved){
        try { appConfig = JSON.parse(saved); } catch{}
      }
      API_KEY = appConfig.cloudConfig?.apiKey || '';
      BIN_ID  = appConfig.cloudConfig?.binId  || '';
      document.getElementById('config-api-key').value = API_KEY;
      document.getElementById('config-bin-id').value  = BIN_ID;
    }

    function salvaConfigurazione(){
      localStorage.setItem('appConfig', JSON.stringify(appConfig));
      showStatus('Configurazione salvata','success');
    }

    function aggiornaInterfaccia(){
      populateSelectOptions();
    }

    function aggiornaListeConfigurazione(){
      const listaOperatori = document.getElementById('lista-operatori');
      listaOperatori.innerHTML = '';
      appConfig.operatori.forEach((op, i)=>{
        const div = document.createElement('div');
        div.className = 'config-item';
        div.innerHTML = `<span>${op}</span><button onclick="rimuoviOperatore(${i})">üóëÔ∏è</button>`;
        listaOperatori.appendChild(div);
      });

      const listaTL = document.getElementById('lista-team-leaders');
      listaTL.innerHTML = '';
      appConfig.teamLeaders.forEach((tl, i)=>{
        const div = document.createElement('div');
        div.className = 'config-item';
        div.innerHTML = `<span>${tl}</span><button onclick="rimuoviTeamLeader(${i})">üóëÔ∏è</button>`;
        listaTL.appendChild(div);
      });

      const listaFmt = document.getElementById('lista-formati');
      listaFmt.innerHTML = '';
      appConfig.formati.forEach((f, i)=>{
        const div = document.createElement('div');
        div.className = 'config-item';
        div.innerHTML = `<span>${f}</span><button onclick="rimuoviFormato(${i})">üóëÔ∏è</button>`;
        listaFmt.appendChild(div);
      });

      buildCasisticheEditor();
    }

    function aggiungiOperatore(){
      const input = document.getElementById('nuovo-operatore');
      const nome = input.value.trim();
      if(nome && !appConfig.operatori.includes(nome)){
        appConfig.operatori.push(nome); salvaConfigurazione(); aggiornaInterfaccia(); aggiornaListeConfigurazione(); input.value=''; showStatus('Operatore aggiunto','success');
      } else { showStatus('Nome vuoto o gi√† presente','error'); }
    }
    function rimuoviOperatore(i){ if(confirm(`Rimuovere "${appConfig.operatori[i]}"?`)){ appConfig.operatori.splice(i,1); salvaConfigurazione(); aggiornaInterfaccia(); aggiornaListeConfigurazione(); } }

    function aggiungiTeamLeader(){
      const input = document.getElementById('nuovo-team-leader');
      const nome = input.value.trim();
      if(nome && !appConfig.teamLeaders.includes(nome)){
        appConfig.teamLeaders.push(nome); salvaConfigurazione(); aggiornaInterfaccia(); aggiornaListeConfigurazione(); input.value=''; showStatus('Team Leader aggiunto','success');
      } else { showStatus('Nome vuoto o gi√† presente','error'); }
    }
    function rimuoviTeamLeader(i){ if(confirm(`Rimuovere "${appConfig.teamLeaders[i]}"?`)){ appConfig.teamLeaders.splice(i,1); salvaConfigurazione(); aggiornaInterfaccia(); aggiornaListeConfigurazione(); } }

    function aggiungiFormato(){
      const input = document.getElementById('nuovo-formato');
      const val = input.value.trim();
      if(val && !appConfig.formati.includes(val)){
        appConfig.formati.push(val); salvaConfigurazione(); aggiornaInterfaccia(); aggiornaListeConfigurazione(); input.value=''; showStatus('Formato aggiunto','success');
      } else { showStatus('Formato vuoto o gi√† presente','error'); }
    }
    function rimuoviFormato(i){ if(confirm(`Rimuovere "${appConfig.formati[i]}"?`)){ appConfig.formati.splice(i,1); salvaConfigurazione(); aggiornaInterfaccia(); aggiornaListeConfigurazione(); } }

    function aggiungiCasistica(st){
      const input = document.getElementById(`add-${st}`);
      const v = input.value.trim();
      const arr = appConfig.casistichePerStazione[st] || (appConfig.casistichePerStazione[st] = []);
      if(v && !arr.includes(v)){ arr.push(v); salvaConfigurazione(); buildCasisticheEditor(); aggiornaInterfaccia(); input.value=''; showStatus('Casistica aggiunta','success'); }
      else { showStatus('Vuoto o gi√† presente','error'); }
    }
    function rimuoviCasistica(st, i){ if(confirm('Rimuovere casistica?')){ appConfig.casistichePerStazione[st].splice(i,1); salvaConfigurazione(); buildCasisticheEditor(); aggiornaInterfaccia(); } }

    function salvaConfigurazioneCloud(){
      const apiKey = document.getElementById('config-api-key').value.trim();
      const binId  = document.getElementById('config-bin-id').value.trim();
      if(apiKey && binId){
        appConfig.cloudConfig.apiKey = apiKey; appConfig.cloudConfig.binId = binId;
        API_KEY = apiKey; BIN_ID = binId; salvaConfigurazione(); showStatus('Configurazione cloud salvata','success');
      } else showStatus('Inserisci API Key e Bin ID','error');
    }

    async function testConnessioneCloud(){
      const statusDiv = document.getElementById('cloud-status');
      statusDiv.style.display='block'; statusDiv.textContent='üîÑ Test connessione in corso...'; statusDiv.className='status-message warn';
      try{
        const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers:{ 'X-Master-Key': API_KEY } });
        if(r.ok){ statusDiv.textContent = '‚úÖ Connessione al cloud riuscita!'; statusDiv.className='status-message success'; }
        else { throw new Error(`HTTP ${r.status}`); }
      }catch(e){ statusDiv.textContent = `‚ùå Errore connessione: ${e.message}`; statusDiv.className='status-message error'; }
    }

    function esportaConfigurazione(){
      const dataToExport = { config: appConfig, productionData, exportDate: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `configurazione_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url);
      showStatus('Configurazione esportata','success');
    }

    function importaConfigurazione(event){
      const file = event.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const imported = JSON.parse(e.target.result);
          if(imported.config){
            if(confirm('Importare nuova configurazione? Verr√† sovrascritta.')){
              appConfig = imported.config; productionData = imported.productionData || [];
              salvaConfigurazione(); saveToLocal(productionData); aggiornaInterfaccia(); aggiornaListeConfigurazione(); updateRecordsTable(); showStatus('Configurazione importata','success');
            }
          } else { showStatus('File non valido','error'); }
        }catch{ showStatus('Errore nel file importato','error'); }
      };
      reader.readAsText(file); event.target.value='';
    }

    function resetConfigurazione(){
      if(confirm('Ripristinare la configurazione di default? Tutti i dati personalizzati saranno persi.')){
        localStorage.removeItem('appConfig'); location.reload();
      }
    }

    // ====== STORAGE LOCALE / CLOUD ======
    function saveToLocal(data){ localStorage.setItem('productionData', JSON.stringify(data)); }

    async function saveToCloud(data){
      if(!API_KEY || !BIN_ID) throw new Error('Cloud non configurato');
      const resp = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method:'PUT', headers:{ 'Content-Type':'application/json', 'X-Master-Key': API_KEY },
        body: JSON.stringify({ productionData: data, lastUpdated: new Date().toISOString() })
      });
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    }

    async function loadFromCloud(){
      const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers:{ 'X-Master-Key': API_KEY } });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      return data.record?.productionData || [];
    }

    async function caricaSulCloud(){
      try { await saveToCloud(productionData); showStatus('Dati caricati sul cloud','success'); }
      catch(e){ showStatus('Errore upload cloud: '+e.message,'error'); }
    }
    async function sincronizzaDaCloud(){
      try { productionData = await loadFromCloud(); saveToLocal(productionData); updateRecordsTable(); showStatus('Dati scaricati dal cloud','success'); }
      catch(e){ showStatus('Errore download cloud: '+e.message,'error'); }
    }

    // ====== BUSINESS LOGIC ======
    function getShiftRecord(shift){
      const line = document.getElementById('lineaSel').value;
      const operatore = document.getElementById(`${shift}-operatore`).value;
      const teamLeader = document.getElementById(`${shift}-team-leader`).value;
      const formato = document.getElementById(`${shift}-formato`).value;
      const note = document.getElementById(`${shift}-note`).value;

      if(!operatore && !formato){ return null; }

      const stazioni = {};
      appConfig.stazioni.forEach(st=>{
        const caso = (document.getElementById(`${shift}-${st}-caso`)||{}).value || '';
        const min  = parseInt((document.getElementById(`${shift}-${st}-min`)||{}).value || '0', 10);
        if(caso || min>0){ stazioni[st] = { caso, min }; }
      });

      const ric = {
        id: Date.now()+Math.random(),
        date: document.getElementById('workDate').value,
        linea: line,
        shift,
        operatore, teamLeader, formato, note,
        cambioProdotto: parseInt((document.getElementById(`${shift}-cambio-prodotto`)||{}).value||'0',10) || 0,
        lavaggi: parseInt((document.getElementById(`${shift}-lavaggi`)||{}).value||'0',10) || 0,
        cambioFormato: parseInt((document.getElementById(`${shift}-cambio-formato`)||{}).value||'0',10) || 0,
        stazioni,
        timestamp: new Date().toISOString()
      };
      return ric;
    }

    async function saveData(){
      const date = document.getElementById('workDate').value;
      if(!date){ showStatus('Seleziona una data','error'); return; }

      const newRecords = [];
      ['mattina','pomeriggio','notte'].forEach(s=>{ const r = getShiftRecord(s); if(r) newRecords.push(r); });
      if(newRecords.length===0){ showStatus('Inserisci almeno un turno con Operatore e Formato','error'); return; }

      // remove same date+linea
      const linea = document.getElementById('lineaSel').value;
      productionData = productionData.filter(r => !(r.date===date && r.linea===linea));
      productionData.push(...newRecords);

      try { await saveToCloud(productionData); showStatus(`Dati salvati su cloud! (${newRecords.length} record)`, 'success'); }
      catch(e){ saveToLocal(productionData); showStatus('Cloud non disponibile: dati salvati in locale','warn'); }
      updateRecordsTable();
    }

    function exportToCSV(){
      if(productionData.length===0){ showStatus('Nessun dato da esportare','error'); return; }
      const rows = [];
      rows.push(['Data','Linea','Turno','Operatore','Team Leader','Formato','Cambio Prodotto','Lavaggi','Cambio Formato','Stazione','Casistica','Minuti']);
      productionData.forEach(r=>{
        const stz = Object.keys(r.stazioni||{});
        if(stz.length===0){ rows.push([r.date,r.linea,r.shift,r.operatore,r.teamLeader,r.formato,r.cambioProdotto,r.lavaggi,r.cambioFormato,'','','']); }
        else {
          stz.forEach(st=>{
            const {caso,min} = r.stazioni[st]||{caso:'',min:0};
            rows.push([r.date,r.linea,r.shift,r.operatore,r.teamLeader,r.formato,r.cambioProdotto,r.lavaggi,r.cambioFormato,st,caso,min]);
          });
        }
      });
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='cambi_formato.csv'; a.click(); URL.revokeObjectURL(url);
      showStatus('CSV generato','success');
    }

    function showStats(){
      // riepilogo molto semplice: minuti per stazione nell'intervallo visibile (tutto archivio)
      const agg = {};
      productionData.forEach(r=>{ Object.entries(r.stazioni||{}).forEach(([st, v])=>{ agg[st] = (agg[st]||0) + (v?.min||0); }); });
      const msg = Object.keys(agg).sort().map(k=>`${k}: ${agg[k]} min`).join(' \n ')
        || 'Nessun dato disponibile';
      alert('Somma minuti per stazione (tutto archivio):\n\n'+msg);
    }

    function clearDayData(){
      const date = document.getElementById('workDate').value; const linea = document.getElementById('lineaSel').value;
      if(!date) return; if(!confirm(`Cancellare i dati di ${new Date(date).toLocaleDateString('it-IT')} per ${linea}?`)) return;
      productionData = productionData.filter(r => !(r.date===date && r.linea===linea));
      saveToLocal(productionData);
      try{ saveToCloud(productionData); }catch{}
      updateRecordsTable(); showStatus('Giorno cancellato','success');
    }

    function updateRecordsTable(){
      const tbody = document.getElementById('recordsBody'); tbody.innerHTML='';
      const sorted = [...productionData].sort((a,b)=>{
        if(a.date!==b.date) return new Date(b.date) - new Date(a.date);
        const ord = {mattina:1, pomeriggio:2, notte:3}; return ord[a.shift]-ord[b.shift];
      });
      const shiftEmoji = {mattina:'üåÖ', pomeriggio:'‚òÄÔ∏è', notte:'üåô'};
      sorted.forEach(r=>{
        const tr = document.createElement('tr');
        const dettaglio = Object.entries(r.stazioni||{}).map(([st,{caso,min}])=>`${st}: ${caso||'-'} ‚Üí ${min||0}m`).join(' ‚Ä¢ ');
        tr.innerHTML = `
          <td>${new Date(r.date).toLocaleDateString('it-IT')}</td>
          <td>${r.linea}</td>
          <td>${shiftEmoji[r.shift]} ${r.shift}</td>
          <td>${r.operatore||'-'}</td>
          <td>${r.teamLeader||'-'}</td>
          <td>${r.formato||'-'}</td>
          <td>${r.cambioProdotto||0}</td>
          <td>${r.lavaggi||0}</td>
          <td>${r.cambioFormato||0}</td>
          <td>${dettaglio||'-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function loadDayData(){
      // opzionale: potresti pre-caricare i valori del giorno selezionato (qui puliamo i campi)
      ['mattina','pomeriggio','notte'].forEach(shift=>{
        document.getElementById(`${shift}-operatore`).value = '';
        document.getElementById(`${shift}-team-leader`).value = '';
        document.getElementById(`${shift}-formato`).value = '';
        document.getElementById(`${shift}-note`).value = '';
        appConfig.stazioni.forEach(st=>{
          const s1 = document.getElementById(`${shift}-${st}-caso`); if(s1) s1.value='';
          const s2 = document.getElementById(`${shift}-${st}-min`); if(s2) s2.value='';
        });
        ['cambio-prodotto','lavaggi','cambio-formato'].forEach(x=>{ const el = document.getElementById(`${shift}-${x}`); if(el) el.value=''; })
      });
    }

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', async () => {
      // tabs
      document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          const id = tab.getAttribute('data-tab');
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
          tab.classList.add('active'); document.getElementById(id).classList.add('active');
        });
      });

      // data odierna
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('workDate').value = today;

      // build UI
      caricaConfigurazione();
      shifts.forEach(s=>buildShiftCard(s.id));
      populateSelectOptions();
      aggiornaListeConfigurazione();

      // carica dati archivio
      try {
        if(appConfig.cloudConfig?.apiKey && appConfig.cloudConfig?.binId){
          API_KEY = appConfig.cloudConfig.apiKey; BIN_ID = appConfig.cloudConfig.binId;
          productionData = await loadFromCloud();
        } else {
          const localData = localStorage.getItem('productionData');
          productionData = localData ? JSON.parse(localData) : [];
        }
      } catch { const localData = localStorage.getItem('productionData'); productionData = localData ? JSON.parse(localData) : []; }
      updateRecordsTable();

      // autosave leggero (solo locale) ogni 30s
      setInterval(()=>{ saveToLocal(productionData); }, 30000);

      // change date handler
      document.getElementById('workDate').addEventListener('change', loadDayData);
    });
  </script>
</body>
</html>
